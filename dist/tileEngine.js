kontra.tileEngine=function(t){function e(t){let e,r;return void 0!==t.x&&void 0!==t.y?(e=p.getRow(t.y),r=p.getCol(t.x)):(e=t.row,r=t.col),e<0||r<0||e>=n||r>=s?-1:r+e*s}function r(t){let e,r,i=0,a=p.tilesets.length-1;for(;i<=a;){if(e=(i+a)/2|0,t>=(r=p.tilesets[e]).firstGrid&&t<=r.lastGrid)return r;r.lastGrid<t?i=e+1:a=e-1}}let i,a,s=(t=t||{}).width,n=t.height,l=t.tileWidth||t.tilewidth||32,o=t.tileHeight||t.tileheight||32,d=s*l,h=n*o,f=t.context||kontra.context,g=f.canvas.width,c=f.canvas.height,y=document.createElement("canvas"),u=y.getContext("2d"),m=Math.max(0,d-g),x=Math.max(0,h-c),w=[],p={width:s,height:n,tileWidth:l,tileHeight:o,mapWidth:d,mapHeight:h,context:f,x:t.x||0,y:t.y||0,tilesets:[],layers:{},addTilesets:function(t){[].concat(t).map(function(t){let e,r,i,a,s,n=t.image;if(""+n===n){let t=1/0;for(;t>=0;){let r=(t=n.lastIndexOf("/",t))<0?n:n.substr(t);if(kontra.assets.images[r]){e=kontra.assets.images[r];break}t--}}else e=n;r=t.firstGrid,i=(e.width/l|0||1)*(e.height/o|0||1),r||(p.tilesets.length>0?(s=((a=p.tilesets[p.tilesets.length-1]).image.width/l|0)*(a.image.height/o|0),r=a.firstGrid+s):r=1),p.tilesets.push({firstGrid:r,lastGrid:r+i-1,image:e}),p.tilesets.sort(function(t,e){return t.firstGrid-e.firstGrid})})},addLayers:function(t){[].concat(t).map(function(t){let e,r,i,a,n,l;if(t.render=void 0===t.render||t.render,Array.isArray(t.data[0]))for(e=[],r=0;i=t.data[r];r++)for(a=0;a<s;a++)e.push(i[a]||0);else e=t.data;for(n in p.layers[t.name]={data:e,zIndex:t.zIndex||0,render:t.render},t.properties){l=t.properties[n];try{l=JSON.parse(l)}catch(t){}p.layers[t.name][n]=l}p.layers[t.name].render&&(w.push(t.name),w.sort(function(t,e){return p.layers[t].zIndex-p.layers[e].zIndex}))}),function(){let t,e,i,a,n,d,h,f,g;for(let c,y=0;c=p.layers[w[y]];y++)for(let y=0,m=c.data.length;y<m;y++)(t=c.data[y])&&(i=(e=r(t)).image,a=y%s*l,n=(y/s|0)*o,d=(f=t-e.firstGrid)%(g=i.width/l)*l,h=(f/g|0)*o,u.drawImage(i,d,h,l,o,a,n,l,o))}()},layerCollidesWith:function(t,r){let i,a=p.getRow(r.y),s=p.getCol(r.x),n=p.getRow(r.y+r.height),l=p.getCol(r.x+r.width);for(let r=a;r<=n;r++)for(let a=s;a<=l;a++)if(i=e({row:r,col:a}),p.layers[t].data[i])return!0;return!1},tileAtLayer:function(t,r){let i=e(r);if(i>=0)return p.layers[t].data[i]},render:function(){p.context.drawImage(y,p.sx,p.sy,g,c,p.x,p.y,g,c)},renderLayer:function(t){let i,a,d,h,f,y,u,m,x,w=p.layers[t],G=p.getRow(),M=p.getCol(),I=e({row:G,col:M}),C=M*l-p.sx,v=G*o-p.sy,k=Math.min(Math.ceil(g/l)+1,s),R=k*Math.min(Math.ceil(c/o)+1,n),z=0;for(;z<R;)(d=w.data[I])&&(f=(h=r(d)).image,i=C+z%k*l,a=v+(z/k|0)*o,m=(y=d-h.firstGrid)%(u=f.width/l)*l,x=(y/u|0)*o,p.context.drawImage(f,m,x,l,o,i,a,l,o)),++z%k==0?I=M+ ++G*s:I++},getRow:function(t){return t=t||0,(p.sy+t)/o|0},getCol:function(t){return t=t||0,(p.sx+t)/l|0},get sx(){return i},get sy(){return a},set sx(t){i=Math.min(Math.max(0,t),m)},set sy(t){a=Math.min(Math.max(0,t),x)}};p.sx=t.sx||0,p.sy=t.sy||0,y.width=d,y.height=h;for(let e in t.properties){let r=t.properties[e];try{r=JSON.parse(r)}catch(t){}p[e]=p[e]||r}return t.tilesets&&p.addTilesets(t.tilesets),t.layers&&p.addLayers(t.layers),p};