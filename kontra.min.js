function qFactory(t,e){function i(t,e,n){var s;if(t)if(o(t))for(s in t)"prototype"==s||"length"==s||"name"==s||t.hasOwnProperty&&!t.hasOwnProperty(s)||e.call(n,t[s],s);else if(t.forEach&&t.forEach!==i)t.forEach(e,n);else if(h(t))for(s=0;s<t.length;s++)e.call(n,t[s],s);else for(s in t)t.hasOwnProperty(s)&&e.call(n,t[s],s);return t}function n(t){return t}function s(t){return d(t)}function r(t){var e=c(),n=0,s=h(t)?[]:{};return i(t,function(t,i){n++,u(t).then(function(t){s.hasOwnProperty(i)||(s[i]=t,--n||e.resolve(s))},function(t){s.hasOwnProperty(i)||e.reject(t)},function(t){s.hasOwnProperty(i)||e.notify(t)})}),0===n&&e.resolve(s),e.promise}var a={}.toString,o=function(t){return"function"==typeof t},h=function(t){return"[object Array]"===a.call(t)},c=function(){var i,r,a=[];return r={resolve:function(e){if(a){var n=a;a=void 0,i=u(e),n.length&&t(function(){for(var t,e=0,s=n.length;s>e;e++)t=n[e],i.then(t[0],t[1],t[2])})}},reject:function(t){r.resolve(f(t))},notify:function(e){if(a){var i=a;a.length&&t(function(){for(var t,n=0,s=i.length;s>n;n++)t=i[n],t[2](e)})}},promise:{then:function(t,r,h){var u=c(),d=function(i){try{u.resolve((o(t)?t:n)(i))}catch(s){u.reject(s),e(s)}},f=function(t){try{u.resolve((o(r)?r:s)(t))}catch(i){u.reject(i),e(i)}},l=function(t){try{u.notify((o(h)?h:n)(t))}catch(i){e(i)}};return a?a.push([d,f,l]):i.then(d,f,l),u.promise},"catch":function(t){return this.then(null,t)},"finally":function(t){function e(t,e){var i=c();return e?i.resolve(t):i.reject(t),i.promise}function i(i,s){var r=null;try{r=(t||n)()}catch(a){return e(a,!1)}return r&&o(r.then)?r.then(function(){return e(i,s)},function(t){return e(t,!1)}):e(i,s)}return this.then(function(t){return i(t,!0)},function(t){return i(t,!1)})}}}},u=function(e){return e&&o(e.then)?e:{then:function(i){var n=c();return t(function(){n.resolve(i(e))}),n.promise}}},d=function(t){var e=c();return e.reject(t),e.promise},f=function(i){return{then:function(n,r){var a=c();return t(function(){try{a.resolve((o(r)?r:s)(i))}catch(t){a.reject(t),e(t)}}),a.promise}}},l=function(i,r,a,h){var f,l=c(),m=function(t){try{return(o(r)?r:n)(t)}catch(i){return e(i),d(i)}},p=function(t){try{return(o(a)?a:s)(t)}catch(i){return e(i),d(i)}},g=function(t){try{return(o(h)?h:n)(t)}catch(i){e(i)}};return t(function(){u(i).then(function(t){f||(f=!0,l.resolve(u(t).then(m,p,g)))},function(t){f||(f=!0,l.resolve(p(t)))},function(t){f||l.notify(g(t))})}),l.promise};return{defer:c,reject:d,when:l,all:r}}window.q=qFactory(function(t){setTimeout(function(){t()},0)},function(t){console.error("qLite: "+t.stack)});var kontra=function(t,e){var i=/(jpeg|jpg|gif|png)$/,n=/(wav|mp3|ogg|aac|m4a)$/;t.images={},t.audios={},t.data={},t.assetPaths={images:"",audios:"",data:""};var s=new Audio;return t.canUse=t.canUse||{},t.canUse.wav="",t.canUse.mp3=s.canPlayType("audio/mpeg;").replace(/^no$/,""),t.canUse.ogg=s.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),t.canUse.aac=s.canPlayType("audio/aac;").replace(/^no$/,""),t.canUse.m4a=(s.canPlayType("audio/x-m4a;")||t.canUse.aac).replace(/^no$/,""),t._getAssetExtension=function(t){return t.substr((~-t.lastIndexOf(".")>>>0)+2)},t._getAssetType=function(t){var e=this._getAssetExtension(t);return e.match(i)?"Image":e.match(n)?"Audio":"Data"},t._getAssetName=function(t){return t.replace(/\.[^/.]+$/,"")},t.loadAssets=function(){var i,n,s=e.defer(),r=[],a=0,o=arguments.length;arguments.length||s.resolve();for(var h,c=0;h=arguments[c];c++)n=Array.isArray(h)?h[0]:h,i=this._getAssetType(n),function(e){r.push(e.promise),t["load"+i](n).then(function(){e.resolve(),s.notify({loaded:++a,total:o})},function(t){e.reject(t)})}(e.defer());return e.all(r).then(function(){s.resolve()},function(t){s.reject(t)}),s.promise},t.loadImage=function(i){var n=e.defer(),s=this._getAssetName(i),r=new Image;return i=this.assetPaths.images+i,r.onload=function(){t.images[s]=t.images[i]=this,n.resolve(this)},r.onerror=function(){n.reject("Unable to load image "+i)},r.src=i,n.promise},t.loadAudio=function(i){var n,s,r,a,o=e.defer();Array.isArray(i)||(i=[i]);for(var h=0;n=i[h];h++)if(this.canUse[this._getAssetExtension(n)]){r=n;break}return r?(s=this._getAssetName(r),a=new Audio,n=this.assetPaths.audios+r,a.addEventListener("canplay",function(){t.audios[s]=t.audios[n]=this,o.resolve(this)}),a.onerror=function(){o.reject("Unable to load audio "+n)},a.src=n,a.preload="auto",a.load()):o.reject("Browser cannot play any of the audio formats provided"),o.promise},t.loadData=function(i){var n=e.defer(),s=new XMLHttpRequest,r=this._getAssetName(i),a=this.assetPaths.data+i;return s.addEventListener("load",function(){if(200!==s.status)return void n.reject(s.responseText);try{var e=JSON.parse(s.responseText);t.data[r]=t.data[a]=e,n.resolve(e)}catch(i){var o=s.responseText;t.data[r]=t.data[a]=o,n.resolve(o)}}),s.open("GET",a,!0),s.send(),n.promise},t}(kontra||{},q),kontra=function(t,e){return t.bundles={},t.createBundle=function(t,e){this.bundles[t]||(this.bundles[t]=e||[])},t.loadBundles=function(){for(var t,i,n=e.defer(),s=[],r=0,a=0,o=0;i=arguments[o];o++)(t=this.bundles[i])?(a+=t.length,s.push(this.loadAssets.apply(this,t))):n.reject("Bundle '"+i+"' has not been created.");return e.all(s).then(function(){n.resolve()},function(t){n.reject(t)},function(){n.notify({loaded:++r,total:a})}),n.promise},t}(kontra||{},q),kontra=function(t,e){return t.loadManifest=function(i){var n,s=e.defer();return t.loadData(i).then(function(e){t.assetPaths.images=e.imagePath||"",t.assetPaths.audios=e.audioPath||"",t.assetPaths.data=e.dataPath||"";for(var i,r=0;i=e.bundles[r];r++)t.createBundle(i.name,i.assets);return e.loadBundles?(n="all"===e.loadBundles?Object.keys(t.bundles||{}):Array.isArray(e.loadBundles)?e.loadBundles:[e.loadBundles],void t.loadBundles.apply(t,n).then(function(){s.resolve()},function(t){s.reject(t)},function(t){s.notify(t)})):void s.resolve()},function(t){s.reject(t)}),s.promise},t}(kontra||{},q),kontra=function(t,e){"use strict";return t.init=function(i){if(t._isString(i))this.canvas=e.getElementById(i);else if(t._isCanvas(i))this.canvas=i;else if(this.canvas=e.getElementsByTagName("canvas")[0],!this.canvas){var n=new ReferenceError("No canvas element found.");return void t._logError(n,"You must provide a canvas element for the game.")}this.context=this.canvas.getContext("2d")},t._logError=function(t,e){console.error("Kontra: "+e+"\n	"+t.stack)},t._noop=function(){},t._isString=function(t){return"string"==typeof t},t._isNumber=function(t){return"number"==typeof t},t._isImage=function(t){return t instanceof HTMLImageElement},t._isCanvas=function(t){return t instanceof HTMLCanvasElement},t}(kontra||{},document),kontra=function(t,e){"use strict";return t.timestamp=function(){return e.performance&&e.performance.now?function(){return e.performance.now()}:function(){return(new Date).getTime()}}(),t.gameLoop=function(e){var i=Object.create(t.gameLoop.prototype);return i.init(e),i},t.gameLoop.prototype={init:function(e){if(e=e||{},"function"!=typeof e.update||"function"!=typeof e.render){var i=new ReferenceError("Required functions not found");return void t._logError(i,"You must provide update() and render() functions to create a game loop.")}this.isStopped=!0,this._accumulator=0,this._delta=1e3/(e.fps||60),this._step=1/(e.fps||60),this.update=e.update,this.render=e.render,e.clearCanvas===!1&&(this._clearCanvas=t._noop)},start:function(){this._last=t.timestamp(),this.isStopped=!1,requestAnimationFrame(this._frame.bind(this))},stop:function(){this.isStopped=!0,cancelAnimationFrame(this._rAF)},_frame:function(){if(this._rAF=requestAnimationFrame(this._frame.bind(this)),this._now=t.timestamp(),this._dt=this._now-this._last,this._last=this._now,!(this._dt>1e3)){for(this._accumulator+=this._dt;this._accumulator>=this._delta;)this.update(this._step),this._accumulator-=this._delta;this._clearCanvas(),this.render()}},_clearCanvas:function(){t.context.clearRect(0,0,t.canvas.width,t.canvas.height)}},t}(kontra||{},window),kontra=function(t,e){"use strict";function i(t){return"number"==typeof t.which?t.which:t.keyCode}function n(t){var e=[];t=t.trim().replace("++","+plus");for(var i,n=0;i=m[n];n++)-1!==t.indexOf(i)&&(e.push(i),t=t.replace(i,""));return t=t.replace(/\+/g,"").toLowerCase(),f[t]?e.push("shift+"+f[t]):t&&e.push(t),e.join("+")}function s(t){for(var e,n=[],s=0;e=m[s];s++)t[e+"Key"]&&n.push(e);var r=u[i(t)];return-1===n.indexOf(r)&&n.push(r),n.join("+")}function r(t){for(var e,i=s(t),n=0,r=i.split("+");e=r[n];n++)c[e]=!0;h[i]&&h[i](t,i)}function a(t){var e=u[i(t)];c[e]=!1,l[e]&&(c[l[e]]=!1)}function o(t){c={}}for(var h={},c={},u={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",91:"leftwindow",92:"rightwindow",93:"select",144:"numlock",145:"scrolllock",106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},d=0;26>d;d++)u[65+d]=String.fromCharCode(65+d).toLowerCase();for(d=0;10>d;d++)u[48+d]=""+d;for(d=1;20>d;d++)u[111+d]="f"+d;for(d=0;10>d;d++)u[96+d]="numpad"+d;var f={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\",plus:"="},l={leftwindow:"meta",select:"meta"},m=["meta","ctrl","alt","shift"];return e.addEventListener("keydown",r),e.addEventListener("keyup",a),e.addEventListener("blur",o),t.keys={},t.keys.bind=function(e,i){if("function"!=typeof i){var s=new SyntaxError("Invalid function.");return void t._logError(s,"You must provide a function as the second parameter.")}e=Array.isArray(e)?e:[e];for(var r,a=0;r=e[a];a++){var o=n(r);h[o]=i}},t.keys.unbind=function(t){t=Array.isArray(t)?t:[t];for(var e,i=0;e=t[i];i++){var s=n(e);h[s]=void 0}},t.keys.pressed=function(t){var e=n(t),i=!0;t=e.split("+");for(var s,r=0;s=t[r];r++)i=i&&!!c[s];return i},t}(kontra||{},window),kontra=function(t){"use strict";return t.pool=function(e){var i=Object.create(t.pool.prototype);return i.init(e),i},t.pool.prototype={init:function(e){e=e||{};var i,n;if("function"!=typeof e.create)return i=new SyntaxError("Required function not found."),void t._logError(i,"Parameter 'create' must be a function that returns an object.");if(this.create=e.create.bind(this,e.createProperties||{}),n=this.create(),!n||"function"!=typeof n.render||"function"!=typeof n.update||"function"!=typeof n.init||"function"!=typeof n.isAlive)return i=new SyntaxError("Create object required functions not found."),void t._logError(i,"Objects to be pooled must implement render(), update(), init() and isAlive() functions.");if(this.objects=[n],this.size=1,this.maxSize=e.maxSize||1/0,this.lastIndex=0,this.inUse=0,e.fill){if(!e.maxSize)return i=new SyntaxError("Required property not found."),void t._logError(i,"Parameter 'maxSize' must be set before you can fill a pool.");for(;this.objects.length<this.maxSize;)this.objects.unshift(this.create());this.size=this.maxSize,this.lastIndex=this.maxSize-1}},get:function(t){if(t=t||{},this.objects[0].isAlive()){if(this.size===this.maxSize)return;for(var e=0;e<this.size&&this.objects.length<this.maxSize;e++)this.objects.unshift(this.create());this.size=this.objects.length,this.lastIndex=this.size-1}var i=this.objects[0];i.init(t);for(var n=1;n<this.size;n++)this.objects[n-1]=this.objects[n];this.objects[this.lastIndex]=i,this.inUse++},getAliveObjects:function(){return this.objects.slice(this.objects.length-this.inUse)},clear:function(){this.inUse=0,this.size=1,this.lastIndex=0,this.objects.length=0,this.objects.push(this.create())},update:function(t){for(var e,i=this.lastIndex,n=Math.max(this.objects.length-this.inUse,0);i>=n;)if(e=this.objects[i],e.update(t),e.isAlive())i--;else{for(var s=i;s>0;s--)this.objects[s]=this.objects[s-1];this.objects[0]=e,this.inUse--,n++}},render:function(){for(var t=Math.max(this.objects.length-this.inUse,0),e=this.lastIndex;e>=t;e--)this.objects[e].render()}},t}(kontra||{}),kontra=function(t,e){"use strict";return t.quadtree=function(e){var i=Object.create(t.quadtree.prototype);return i.init(e),i},t.quadtree.prototype={init:function(e){e=e||{},this.depth=e.depth||0,this.maxDepth=e.maxDepth||3,this.maxObjects=e.maxObjects||25,this.isBranchNode=!1,this.parentNode=e.parentNode,this.bounds=e.bounds||{x:0,y:0,width:t.canvas.width,height:t.canvas.height},this.objects=[],this.subnodes=[]},clear:function(){if(this.isBranchNode)for(var t=0;4>t;t++)this.subnodes[t].clear();this.isBranchNode=!1,this.objects.length=0},get:function(t){for(var e,i,n=this,s=[];n.subnodes.length&&this.isBranchNode;){e=this._getIndex(t);for(var r=0,a=e.length;a>r;r++)i=e[r],s.push.apply(s,this.subnodes[i].get(t));return s}return n.objects},add:function(){for(var t,e,i,n=0,s=arguments.length;s>n;n++)if(e=arguments[n],Array.isArray(e))this.add.apply(this,e);else if(this.subnodes.length&&this.isBranchNode)this._addToSubnode(e);else if(this.objects.push(e),this.objects.length>this.maxObjects&&this.depth<this.maxDepth){for(this._split(),t=0;i=this.objects[t];t++)this._addToSubnode(i);this.objects.length=0}},_addToSubnode:function(t){for(var e=this._getIndex(t),i=0,n=e.length;n>i;i++)this.subnodes[e[i]].add(t)},_getIndex:function(t){var e=[],i=this.bounds.x+this.bounds.width/2,n=this.bounds.y+this.bounds.height/2,s=t.y<n&&t.y+t.height>=this.bounds.y,r=t.y+t.height>=n&&t.y<this.bounds.y+this.bounds.height;return t.x<i&&t.x+t.width>=this.bounds.x&&(s&&e.push(0),r&&e.push(2)),t.x+t.width>=i&&t.x<this.bounds.x+this.bounds.width&&(s&&e.push(1),r&&e.push(3)),e},_split:function(){if(this.isBranchNode=!0,!this.subnodes.length)for(var e=this.bounds.width/2|0,i=this.bounds.height/2|0,n=0;4>n;n++)this.subnodes[n]=t.quadtree({bounds:{x:this.bounds.x+(n%2===1?e:0),y:this.bounds.y+(n>=2?i:0),width:e,height:i},depth:this.depth+1,maxDepth:this.maxDepth,maxObjects:this.maxObjects,parentNode:this})},render:function(){if((this.objects.length||0===this.depth||this.parentNode&&this.parentNode.isBranchNode)&&(t.context.strokeStyle="red",t.context.strokeRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height),this.subnodes.length))for(var e=0;4>e;e++)this.subnodes[e].render()}},t}(kontra||{}),kontra=function(t,e,i){"use strict";return t.vector=function(e){var i=Object.create(t.vector.prototype);return i.init(e),i},t.vector.prototype={init:function(t){return t=t||{},this.x=t.x||0,this.y=t.y||0,this},add:function(t,e){this.x+=(t.x||0)*(e||1),this.y+=(t.y||0)*(e||1)},clamp:function(t,n,s,r){this._xMin=t!==i?t:-(1/0),this._xMax=s!==i?s:1/0,this._yMin=n!==i?n:-(1/0),this._yMax=r!==i?r:1/0,this._x=this.x,this._y=this.y,Object.defineProperties(this,{x:{get:function(){return this._x},set:function(t){this._x=e.min(e.max(t,this._xMin),this._xMax)}},y:{get:function(){return this._y},set:function(t){this._y=e.min(e.max(t,this._yMin),this._yMax)}}})}},t.sprite=function(e){var i=Object.create(t.sprite.prototype);return i.init(e),i},t.sprite.prototype={init:function(e){e=e||{},this.position=(this.position||t.vector()).init({x:e.x,y:e.y}),this.velocity=(this.velocity||t.vector()).init({x:e.dx,y:e.dy}),this.acceleration=(this.acceleration||t.vector()).init({x:e.ddx,y:e.ddy});for(var i in e)e.hasOwnProperty(i)&&(this[i]=e[i]);this.timeToLive=e.timeToLive||0,this.context=e.context||t.context,t._isImage(e.image)||t._isCanvas(e.image)?(this.image=e.image,this.width=e.image.width,this.height=e.image.height,this.advance=this._advanceSprite,this.draw=this._drawImage):e.animations?(this.animations=e.animations,this.currentAnimation=e.animations[Object.keys(e.animations)[0]],this.width=this.currentAnimation.width,this.height=this.currentAnimation.height,this.advance=this._advanceAnimation,this.draw=this._drawAnimation):(this.color=e.color,this.width=e.width,this.height=e.height,this.advance=this._advanceSprite,this.draw=this._drawRect)},get x(){return this.position.x},get y(){return this.position.y},get dx(){return this.velocity.x},get dy(){return this.velocity.y},get ddx(){return this.acceleration.x},get ddy(){return this.acceleration.y},set x(t){this.position.x=t},set y(t){this.position.y=t},set dx(t){this.velocity.x=t},set dy(t){this.velocity.y=t},set ddx(t){this.acceleration.x=t},set ddy(t){this.acceleration.y=t},isAlive:function(){return this.timeToLive>0},collidesWith:function(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y},update:function(t){this.advance(t)},render:function(){this.draw()},playAnimation:function(t){this.currentAnimation=this.animations[t]},_advanceSprite:function(t){this.velocity.add(this.acceleration,t),this.position.add(this.velocity,t),this.timeToLive--},_advanceAnimation:function(t){this._advanceSprite(t),this.currentAnimation.update(t)},_drawRect:function(){this.context.fillStyle=this.color,this.context.fillRect(this.x,this.y,this.width,this.height)},_drawImage:function(){this.context.drawImage(this.image,this.x,this.y)},_drawAnimation:function(){this.currentAnimation.render({context:this.context,x:this.x,y:this.y})}},t}(kontra||{},Math),kontra=function(t,e){"use strict";return t.animation=function(e){var i=Object.create(t.animation.prototype);return i.init(e),i},t.animation.prototype={init:function(t){t=t||{},this.spriteSheet=t.spriteSheet,this.frames=t.frames,this.frameRate=t.frameRate,this.width=t.spriteSheet.frame.width,this.height=t.spriteSheet.frame.height,this.currentFrame=0,this._accumulator=0,this.update=this._advance,this.render=this._draw},play:function(){this.update=this._advance,this.render=this._draw},stop:function(){this.update=t._noop,this.render=t._noop},pause:function(){this.update=t._noop},clone:function(){return t.animation(this)},_advance:function(t){for(t=t||1/60,this._accumulator+=t;this._accumulator*this.frameRate>=1;)this.currentFrame=++this.currentFrame%this.frames.length,this._accumulator-=1/this.frameRate},_draw:function(e){e=e||{};var i=e.context||t.context,n=this.frames[this.currentFrame]/this.spriteSheet.framesPerRow|0,s=this.frames[this.currentFrame]%this.spriteSheet.framesPerRow|0;i.drawImage(this.spriteSheet.image,s*this.spriteSheet.frame.width,n*this.spriteSheet.frame.height,this.spriteSheet.frame.width,this.spriteSheet.frame.height,e.x,e.y,this.spriteSheet.frame.width,this.spriteSheet.frame.height)}},t.spriteSheet=function(e){var i=Object.create(t.spriteSheet.prototype);return i.init(e),i},t.spriteSheet.prototype={init:function(e){if(e=e||{},this.animations={},!t._isImage(e.image)&&!t._isCanvas(e.image)){var i=new SyntaxError("Invalid image.");return void t._logError(i,"You must provide an Image for the SpriteSheet.")}this.image=e.image,this.frame={width:e.frameWidth,height:e.frameHeight},this.framesPerRow=e.image.width/e.frameWidth|0,e.animations&&this.createAnimations(e.animations)},createAnimations:function(i){var n;if(!i||0===Object.keys(i).length)return n=new ReferenceError("No animations found."),void t._logError(n,"You must provide at least one named animation to create an Animation.");var s,r,a,o;for(var h in i)if(i.hasOwnProperty(h)){if(s=i[h],r=s.frames,a=s.frameRate,o=[],r===e)return n=new ReferenceError("No animation frames found."),void t._logError(n,"Animation "+h+" must provide a frames property.");if(t._isNumber(r))o.push(r);else if(t._isString(r))o=this._parseFrames(r);else{if(!Array.isArray(r))return n=new SyntaxError("Improper frames value"),void t._logError(n,"The frames property must be a number, string, or array.");for(var c,u=0;c=r[u];u++)t._isString(c)?o.push.apply(o,this._parseFrames(c)):o.push(c)}this.animations[h]=t.animation({spriteSheet:this,frames:o,frameRate:a})}},_parseFrames:function(t){var e,i=[],n=t.split("..").map(Number),s=n[0]<n[1]?1:-1;if(1===s)for(e=n[0];e<=n[1];e++)i.push(e);else for(e=n[0];e>=n[1];e--)i.push(e);return i}},t}(kontra||{}),kontra=function(t,e,i,n){"use strict";return t.canUse=t.canUse||{},t.canUse.localStorage="localStorage"in e&&null!==e.localStorage,t.canUse.localStorage?(t.store={},t.store.set=function(t,e){e===n?this.remove(t):i.setItem(t,JSON.stringify(e))},t.store.get=function(t){var e=i.getItem(t);try{e=JSON.parse(e)}catch(n){}return e},t.store.remove=function(t){i.removeItem(t)},t.store.clear=function(){i.clear()},t):t}(kontra||{},window,window.localStorage),kontra=function(t,e,i){"use strict";return t.tileEngine=function(e){var i=Object.create(t.tileEngine.prototype);return i.init(e),i},t.tileEngine.prototype={init:function(i){if(i=i||{},!i.width||!i.height){var n=new ReferenceError("Required parameters not found");return void t._logError(n,"You must provide width and height of the map to create a tile engine.")}this.width=i.width,this.height=i.height,this.tileWidth=i.tileWidth||32,this.tileHeight=i.tileHeight||32,this.context=i.context||t.context,this.canvasWidth=this.context.canvas.width,this.canvasHeight=this.context.canvas.height,this._offscreenCanvas=document.createElement("canvas"),this._offscreenContext=this._offscreenCanvas.getContext("2d"),this._offscreenCanvas.width=this.mapWidth=this.width*this.tileWidth,this._offscreenCanvas.height=this.mapHeight=this.height*this.tileHeight,this.sxMax=e.max(0,this.mapWidth-this.canvasWidth),this.syMax=e.max(0,this.mapHeight-this.canvasHeight),this.layers={},this._layerOrder=[],this.tilesets=[],this.x=i.x||0,this.y=i.y||0,this.sx=i.sx||0,this.sy=i.sy||0},addTileset:function(e){if(e=e||{},!t._isImage(e.image)&&!t._isCanvas(e.image)){var i=new SyntaxError("Invalid image.");return void t._logError(i,"You must provide an Image for the tile engine.")}var n=e.image,s=e.firstGrid,r=(n.width/this.tileWidth|0||1)*(n.height/this.tileHeight|0||1);if(!s)if(this.tilesets.length>0){var a=this.tilesets[this.tilesets.length-1],o=(a.image.width/this.tileWidth|0)*(a.image.height/this.tileHeight|0);s=a.firstGrid+o}else s=1;this.tilesets.push({firstGrid:s,lastGrid:s+r-1,image:n}),this.tilesets.sort(function(t,e){return t.firstGrid-e.firstGrid})},addLayer:function(t){t=t||{},t.render=t.render===i?!0:t.render;var e;if(Array.isArray(t.data[0])){e=[];for(var n,s=0;n=t.data[s];s++)for(var r=0;r<this.width;r++)e.push(n[r]||0)}else e=t.data;this.layers[t.name]=e,this.layers[t.name].zIndex=t.zIndex||0,this.layers[t.name].render=t.render,t.render&&(this._layerOrder.push(t.name),this._layerOrder.sort(function(t,e){return this.layers[t].zIndex-this.layers[e].zIndex}.bind(this)),this._preRenderImage())},layerCollidesWith:function(t,e){for(var i,n=this.getRow(e.y),s=this.getCol(e.x),r=this.getRow(e.y+e.height),a=this.getCol(e.x+e.width),o=n;r>=o;o++)for(var h=s;a>=h;h++)if(i=this._getIndex({row:o,col:h}),this.layers[t][i])return!0;return!1},tileAtLayer:function(t,e){var i=this._getIndex(e);return i>=0?this.layers[t][i]:void 0},render:function(){this.sx=e.min(e.max(this.sx,0),this.sxMax),this.sy=e.min(e.max(this.sy,0),this.syMax),this.context.drawImage(this._offscreenCanvas,this.sx,this.sy,this.canvasWidth,this.canvasHeight,this.x,this.y,this.canvasWidth,this.canvasHeight)},renderLayer:function(t){for(var i,n,s,r,a,o,h,c,u,d=this.layers[t],f=this.getRow(),l=this.getCol(),m=this._getIndex({row:f,col:l}),p=l*this.tileWidth-this.sx,g=f*this.tileHeight-this.sy,v=e.min(e.ceil(this.canvasWidth/this.tileWidth)+1,this.width),y=e.min(e.ceil(this.canvasHeight/this.tileHeight)+1,this.height),x=v*y,b=0;x>b;)s=d[m],s&&(r=this._getTileset(s),a=r.image,i=p+b%v*this.tileWidth,n=g+(b/v|0)*this.tileHeight,o=s-r.firstGrid,h=a.width/this.tileWidth,c=o%h*this.tileWidth,u=(o/h|0)*this.tileHeight,this.context.drawImage(a,c,u,this.tileWidth,this.tileHeight,i,n,this.tileWidth,this.tileHeight)),++b%v===0?m=l+ ++f*this.width:m++},getRow:function(t){return t=t||0,(this.sy+t)/this.tileHeight|0},getCol:function(t){return t=t||0,(this.sx+t)/this.tileWidth|0},_getIndex:function(t){var e,i;return"undefined"!=typeof t.x&&"undefined"!=typeof t.y?(e=this.getRow(t.y),i=this.getCol(t.x)):(e=t.row,i=t.col),0>e||0>i||e>=this.height||i>=this.width?-1:i+e*this.width},_getTileset:function(t){for(var e,i,n=0,s=this.tilesets.length-1;s>=n;){if(e=(n+s)/2|0,i=this.tilesets[e],t>=i.firstGrid&&t<=i.lastGrid)return i;i.lastGrid<t?n=e+1:s=e-1}},_preRenderImage:function(){for(var t,e,i,n,s,r,a,o,h,c,u=0;c=this.layers[this._layerOrder[u]];u++)for(var d=0,f=c.length;f>d;d++)t=c[d],t&&(e=this._getTileset(t),i=e.image,n=d%this.width*this.tileWidth,s=(d/this.width|0)*this.tileHeight,o=t-e.firstGrid,h=i.width/this.tileWidth,r=o%h*this.tileWidth,a=(o/h|0)*this.tileHeight,this._offscreenContext.drawImage(i,r,a,this.tileWidth,this.tileHeight,n,s,this.tileWidth,this.tileHeight))}},t}(kontra||{},Math);