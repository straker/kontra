var kontra=function(){"use strict";let t,i,e={};function s(t,i){e[t]=e[t]||[],e[t].push(i)}function h(t,...i){e[t]&&e[t].map(t=>t(...i))}function n(){return t}function o(){return i}const r=()=>{};function a(t){function i(){return new t(...arguments)}return i.prototype=t.prototype,i.class=t,i}class c{constructor({spriteSheet:t,frames:i,frameRate:e,loop:s=!0}={}){this.spriteSheet=t,this.frames=i,this.frameRate=e,this.loop=s;let{width:h,height:n,margin:o=0}=t.frame;this.width=h,this.height=n,this.margin=o,this._f=0,this._a=0}clone(){return new c(this)}reset(){this._f=0,this._a=0}update(t=1/60){if(this.loop||this._f!=this.frames.length-1)for(this._a+=t;this._a*this.frameRate>=1;)this._f=++this._f%this.frames.length,this._a-=1/this.frameRate}render({x:t,y:i,width:e=this.width,height:s=this.height,context:h=o()}={}){let n=this.frames[this._f]/this.spriteSheet._f|0,r=this.frames[this._f]%this.spriteSheet._f|0;h.drawImage(this.spriteSheet.image,r*this.width+(2*r+1)*this.margin,n*this.height+(2*n+1)*this.margin,this.width,this.height,t,i,e,s)}}var l=a(c);let d=/(jpeg|jpg|gif|png)$/,u=/(wav|mp3|ogg|aac)$/,f=/^\//,g=/\/$/,_=new WeakMap,p="",m="",x="";function w(t,i){return new URL(t,i).href}function y(t,i){return[t.replace(g,""),t?i.replace(f,""):i].filter(t=>t).join("/")}function v(t){return t.split(".").pop()}function b(t){let i=t.replace("."+v(t),"");return 2==i.split("/").length?i.replace(f,""):i}let A={},j={},P={};function S(){window.__k||(window.__k={dm:_,u:w,d:P,i:A})}function O(t){return S(),new Promise((i,e)=>{let s,n,o;if(s=y(p,t),A[s])return i(A[s]);(n=new Image).onload=function(){o=w(s,window.location.href),A[b(t)]=A[s]=A[o]=this,h("assetLoaded",this,t),i(this)},n.onerror=function(){e(s)},n.src=s})}function E(t){return new Promise((i,e)=>{let s,n,o,r;return s=new Audio,n=function(t){return{wav:"",mp3:t.canPlayType("audio/mpeg;"),ogg:t.canPlayType('audio/ogg; codecs="vorbis"'),aac:t.canPlayType("audio/aac;")}}(s),(t=[].concat(t).reduce((t,i)=>t||(n[v(i)]?i:null),0))?(o=y(m,t),j[o]?i(j[o]):(s.addEventListener("canplay",function(){r=w(o,window.location.href),j[b(t)]=j[o]=j[r]=this,h("assetLoaded",this,t),i(this)}),s.onerror=function(){e(o)},s.src=o,void s.load())):e(t)})}function L(t){let i,e;return S(),i=y(x,t),P[i]?Promise.resolve(P[i]):fetch(i).then(t=>{if(!t.ok)throw t;return t.clone().json().catch(()=>t.text())}).then(s=>(e=w(i,window.location.href),"object"==typeof s&&_.set(s,e),P[b(t)]=P[i]=P[e]=s,h("assetLoaded",s,t),s))}function k(){let t=n();o().clearRect(0,0,t.width,t.height)}class I{constructor(t=0,i=0,e={}){this._x=t,this._y=i,e._c&&(this.clamp(e._a,e._b,e._d,e._e),this.x=t,this.y=i)}add(t,i=1){return new I(this.x+(t.x||0)*i,this.y+(t.y||0)*i,this)}clamp(t,i,e,s){this._c=!0,this._a=t,this._b=i,this._d=e,this._e=s}get x(){return this._x}get y(){return this._y}set x(t){this._x=this._c?Math.min(Math.max(this._a,t),this._d):t}set y(t){this._y=this._c?Math.min(Math.max(this._b,t),this._e):t}}var M=a(I);var C=a(class{constructor(t){this.init(t)}init(t={}){this.position=M(),this.width=this.height=0,this.context=o(),this.localPosition=M(),this.localRotation=0,this._rot=0,this.children=[],this.velocity=M(),this.acceleration=M(),this.rotation=0,this.ttl=1/0,this.anchor={x:0,y:0},this.sx=this.sy=0,Object.assign(this,t)}get x(){return this.position.x}get y(){return this.position.y}set x(t){this.position.x=t,this.localPosition.x=this.parent?t-this.parent.x:t,this.children.map(i=>{i.localPosition&&(i.x=t+i.localPosition.x)})}set y(t){this.position.y=t,this.localPosition.y=this.parent?t-this.parent.y:t,this.children.map(i=>{i.localPosition&&(i.y=t+i.localPosition.y)})}get dx(){return this.velocity.x}get dy(){return this.velocity.y}set dx(t){this.velocity.x=t}set dy(t){this.velocity.y=t}get ddx(){return this.acceleration.x}get ddy(){return this.acceleration.y}set ddx(t){this.acceleration.x=t}set ddy(t){this.acceleration.y=t}get viewX(){return this.x-this.sx}get viewY(){return this.y-this.sy}set viewX(t){}set viewY(t){}isAlive(){return this.ttl>0}get rotation(){return this._rot}set rotation(t){this._rot=t,this.localRotation=this.parent?t-this.parent.rotation:t,this.children.map(i=>{i.localRotation&&(i.rotation=t+i.localRotation)})}addChild(t){this.children.push(t),t.parent=this,t.x=t.x,t.y=t.y,t.rotation=t.rotation}removeChild(t){let i=this.children.indexOf(t);-1!==i&&(this.children.splice(i,1),t.parent=null,t.x=t.x,t.y=t.y,t.rotation=t.rotation)}update(t){this.advance(t)}advance(t){this.velocity=this.velocity.add(this.acceleration,t),this.position=this.position.add(this.velocity,t),this.ttl--}render(){this.draw()}draw(){let t=0,i=0,e=this.x,s=this.y;if(t=-this.width*this.anchor.x,i=-this.height*this.anchor.y,e=this.viewX,s=this.viewY,this.parent&&(e=this.localPosition.x,s=this.localPosition.y),this.context.save(),this.context.translate(e,s),this.rotation){let t=this.rotation;t=this.localRotation,this.context.rotate(t)}this._dc(t,i),this.children.map(t=>t.render&&t.render()),this.context.restore()}_dc(){}});let R={},z={},T={Enter:"enter",Escape:"esc",Space:"space",ArrowLeft:"left",ArrowUp:"up",ArrowRight:"right",ArrowDown:"down",13:"enter",27:"esc",32:"space",37:"left",38:"up",39:"right",40:"down"};function D(t){let i=T[t.code||t.which];z[i]=!0,R[i]&&R[i](t)}function W(t){z[T[t.code||t.which]]=!1}function X(){z={}}function Y(t){let i=t.substr(t.search(/[A-Z]/));return i[0].toLowerCase()+i.substr(1)}function N(t,i){let e=t.indexOf(i);-1!==e&&t.splice(e,1)}let U=[],K=[],q={},B=[],F={},$={0:"left",1:"middle",2:"right"},G={x:0,y:0,radius:5};function H(t,i){const e=i||G;let s=t.x,h=t.y;t.anchor&&(s-=t.width*t.anchor.x,h-=t.height*t.anchor.y);let n=e.x-Math.max(s,Math.min(e.x,s+t.width)),o=e.y-Math.max(h,Math.min(e.y,h+t.height));return n*n+o*o<e.radius*e.radius}function J(t){const i=t||G;let e,s,h=K.length?K:U;for(let t=h.length-1;t>=0;t--)if(s=(e=h[t]).collidesWithPointer?e.collidesWithPointer(i):H(e,i))return e}function Q(t){let i=void 0!==t.button?$[t.button]:"left";F[i]=!0,it(t,"onDown")}function V(t){let i=void 0!==t.button?$[t.button]:"left";F[i]=!1,it(t,"onUp")}function Z(t){it(t,"onOver")}function tt(){F={}}function it(t,i){let e,s,h=n();if(!h)return;let o=h.height/h.offsetHeight,r=h.getBoundingClientRect(),a=-1!==["touchstart","touchmove","touchend"].indexOf(t.type);if(a){G.touches={};for(var c=0;c<t.touches.length;c++)G.touches[t.touches[c].identifier]={id:t.touches[c].identifier,x:(t.touches[c].clientX-r.left)*o,y:(t.touches[c].clientY-r.top)*o,changed:!1};for(c=t.changedTouches.length;c--;){const h=t.changedTouches[c].identifier;void 0!==G.touches[h]&&(G.touches[h].changed=!0),e=t.changedTouches[c].clientX,s=t.changedTouches[c].clientY;let n=J({id:h,x:(e-r.left)*o,y:(s-r.top)*o,radius:G.radius});n&&n[i]&&n[i](t),q[i]&&q[i](t,n)}}else e=t.clientX,s=t.clientY;if(G.x=(e-r.left)*o,G.y=(s-r.top)*o,t.preventDefault(),!a){let e=J();e&&e[i]&&e[i](t),q[i]&&q[i](t,e)}}var et=a(class{constructor({create:t,maxSize:i=1024}={}){this._c=t,this.objects=[t()],this.size=0,this.maxSize=i}get(t={}){if(this.size===this.objects.length){if(this.size===this.maxSize)return;for(let t=0;t<this.size&&this.objects.length<this.maxSize;t++)this.objects.push(this._c())}let i=this.objects[this.size];return this.size++,i.init(t),i}getAliveObjects(){return this.objects.slice(0,this.size)}clear(){this.size=this.objects.length=0,this.objects.push(this._c())}update(t){let i,e=!1;for(let s=this.size;s--;)(i=this.objects[s]).update(t),i.isAlive()||(e=!0,this.size--);e&&this.objects.sort((t,i)=>i.isAlive()-t.isAlive())}render(){for(let t=this.size;t--;)this.objects[t].render()}});function st(t,i){let e=[],s=i.x+i.width/2,h=i.y+i.height/2,n=t.y<h&&t.y+t.height>=i.y,o=t.y+t.height>=h&&t.y<i.y+i.height;return t.x<s&&t.x+t.width>=i.x&&(n&&e.push(0),o&&e.push(2)),t.x+t.width>=s&&t.x<i.x+i.width&&(n&&e.push(1),o&&e.push(3)),e}class ht{constructor({maxDepth:t=3,maxObjects:i=25,bounds:e}={}){this.maxDepth=t,this.maxObjects=i;let s=n();this.bounds=e||{x:0,y:0,width:s.width,height:s.height},this._b=!1,this._d=0,this._o=[],this._s=[],this._p=null}clear(){this._s.map(function(t){t.clear()}),this._b=!1,this._o.length=0}get(t){let i,e,s=new Set;for(;this._s.length&&this._b;){for(i=st(t,this.bounds),e=0;e<i.length;e++)this._s[i[e]].get(t).forEach(t=>s.add(t));return Array.from(s)}return this._o.filter(i=>i!==t)}add(){let t,i,e,s;for(i=0;i<arguments.length;i++)if(e=arguments[i],Array.isArray(e))this.add.apply(this,e);else if(this._b)this._a(e);else if(this._o.push(e),this._o.length>this.maxObjects&&this._d<this.maxDepth){for(this._sp(),t=0;s=this._o[t];t++)this._a(s);this._o.length=0}}_a(t,i,e){for(i=st(t,this.bounds),e=0;e<i.length;e++)this._s[i[e]].add(t)}_sp(t,i,e){if(this._b=!0,!this._s.length)for(t=this.bounds.width/2|0,i=this.bounds.height/2|0,e=0;e<4;e++)this._s[e]=new ht({bounds:{x:this.bounds.x+(e%2==1?t:0),y:this.bounds.y+(e>=2?i:0),width:t,height:i},maxDepth:this.maxDepth,maxObjects:this.maxObjects}),this._s[e]._d=this._d+1}}var nt=a(ht);var ot=a(class extends C.class{init(t={}){this._fx=this._fy=1,super.init(t);let{width:i,height:e,image:s}=t;s&&(this.width=void 0!==i?i:s.width,this.height=void 0!==e?e:s.height)}get animations(){return this._a}set animations(t){let i,e;for(i in this._a={},t)this._a[i]=t[i].clone(),e=e||this._a[i];this.currentAnimation=e,this.width=this.width||e.width,this.height=this.height||e.height}playAnimation(t){this.currentAnimation=this.animations[t],this.currentAnimation.loop||this.currentAnimation.reset()}advance(t){super.advance(t),this.currentAnimation&&this.currentAnimation.update(t)}get width(){return this._w}get height(){return this._h}set width(t){let i=t<0?-1:1;this._fx=i,this._w=t*i}set height(t){let i=t<0?-1:1;this._fy=i,this._h=t*i}_dc(t,i){if(-1==this._fx||-1==this._fy){let e=this.width/2+t,s=this.height/2+i;this.context.translate(e,s),this.context.scale(this._fx,this._fy),this.context.translate(-e,-s)}this.image&&this.context.drawImage(this.image,0,0,this.image.width,this.image.height,t,i,this.width,this.height),this.currentAnimation&&this.currentAnimation.render({x:t,y:i,width:this.width,height:this.height,context:this.context}),this.color&&(this.context.fillStyle=this.color,this.context.fillRect(t,i,this.width,this.height))}});function rt(t){if(+t===t)return t;let i=[],e=t.split(".."),s=+e[0],h=+e[1],n=s;if(s<h)for(;n<=h;n++)i.push(n);else for(;n>=h;n--)i.push(n);return i}var at=a(class{constructor({image:t,frameWidth:i,frameHeight:e,frameMargin:s,animations:h}={}){this.animations={},this.image=t,this.frame={width:i,height:e,margin:s},this._f=t.width/i|0,this.createAnimations(h)}createAnimations(t){let i,e;for(e in t){let{frames:s,frameRate:h,loop:n}=t[e];i=[],[].concat(s).map(t=>{i=i.concat(rt(t))}),this.animations[e]=l({spriteSheet:this,frames:i,frameRate:h,loop:n})}}});var ct=a(class extends C.class{init(t){this.textAlign="",super.init(t),this._p()}get text(){return this._t}set text(t){this._t=t,this._d=!0}get font(){return this._f}set font(t){this._f=t,this._fs=parseInt(t),this._d=!0}get width(){return this._w}set width(t){this._w=t,this._d=!0,this._fw=t}render(){this._d&&this._p(),super.render()}_p(){if(this._s=[],this._d=!1,this.context.font=this.font,!this._s.length&&this._fw){let t=this._t.split(" "),i=0,e=2;for(;e<=t.length;e++){let s=t.slice(i,e).join(" ");this.context.measureText(s).width>this._fw&&(this._s.push(t.slice(i,e-1).join(" ")),i=e-1)}this._s.push(t.slice(i,e).join(" "))}if(!this._s.length&&this._t.includes("\n")){let t=0;this._t.split("\n").map(i=>{this._s.push(i),t=Math.max(t,this.context.measureText(i).width)}),this._w=t}this._s.length||(this._s.push(this.text),this._w=this.context.measureText(this._t).width),this.height=this._s.length*this._fs}_dc(t,i){let e=t,s=this.textAlign;s=this.textAlign||("rtl"===this.context.canvas.dir?"right":"left"),e="right"===s?t+this.width:"center"===s?t+this.width/2|0:t,this._s.map((t,h)=>{this.context.textBaseline="top",this.context.textAlign=s,this.context.fillStyle=this.color,this.context.font=this.font,this.context.fillText(t,e,i+this._fs*h)})}});return{Animation:l,imageAssets:A,audioAssets:j,dataAssets:P,setImagePath:function(t){p=t},setAudioPath:function(t){m=t},setDataPath:function(t){x=t},loadImage:O,loadAudio:E,loadData:L,load:function(...t){return S(),Promise.all(t.map(t=>{let i=v([].concat(t)[0]);return i.match(d)?O(t):i.match(u)?E(t):L(t)}))},collides:function(t,i){if(t.rotation||i.rotation)return null;let e=t.x,s=t.y;t.anchor&&(e-=t.width*t.anchor.x,s-=t.height*t.anchor.y);let h=i.x,n=i.y;return i.anchor&&(h-=i.width*i.anchor.x,n-=i.height*i.anchor.y),e<h+i.width&&e+t.width>h&&s<n+i.height&&s+t.height>n},init:function(e){return t=document.getElementById(e)||e||document.querySelector("canvas"),(i=t.getContext("2d")).imageSmoothingEnabled=!1,h("init"),{canvas:t,context:i}},getCanvas:n,getContext:o,on:s,off:function(t,i){let s;!e[t]||(s=e[t].indexOf(i))<0||e[t].splice(s,1)},emit:h,GameLoop:function({fps:t=60,clearCanvas:i=!0,update:e,render:s}={}){let n,o,a,c,l,d=0,u=1e3/t,f=1/t,g=i?k:r;function _(){if(o=requestAnimationFrame(_),a=performance.now(),c=a-n,n=a,!(c>1e3)){for(h("tick"),d+=c;d>=u;)l.update(f),d-=u;g(),l.render()}}return l={update:e,render:s,isStopped:!0,start(){n=performance.now(),this.isStopped=!1,requestAnimationFrame(_)},stop(){this.isStopped=!0,cancelAnimationFrame(o)}}},GameObject:C,keyMap:T,initKeys:function(){let t;for(t=0;t<26;t++)T[t+65]=T["Key"+String.fromCharCode(t+65)]=String.fromCharCode(t+97);for(t=0;t<10;t++)T[48+t]=T["Digit"+t]=""+t;window.addEventListener("keydown",D),window.addEventListener("keyup",W),window.addEventListener("blur",X)},bindKeys:function(t,i){[].concat(t).map(t=>R[t]=i)},unbindKeys:function(t){[].concat(t).map(t=>R[t]=0)},keyPressed:function(t){return!!z[t]},registerPlugin:function(t,i){let e=t.prototype;e&&(e._inc||(e._inc={},e._bInc=function(t,i,...e){return this._inc[i].before.reduce((i,e)=>{let s=e(t,...i);return s||i},e)},e._aInc=function(t,i,e,...s){return this._inc[i].after.reduce((i,e)=>{let h=e(t,i,...s);return h||i},e)}),Object.getOwnPropertyNames(i).forEach(t=>{let s=Y(t);e[s]&&(e["_o"+s]||(e["_o"+s]=e[s],e[s]=function(...t){let i=this._bInc(this,s,...t),h=e["_o"+s].call(this,...i);return this._aInc(this,s,h,...t)}),e._inc[s]||(e._inc[s]={before:[],after:[]}),t.startsWith("before")?e._inc[s].before.push(i[t]):t.startsWith("after")&&e._inc[s].after.push(i[t]))}))},unregisterPlugin:function(t,i){let e=t.prototype;e&&e._inc&&Object.getOwnPropertyNames(i).forEach(t=>{let s=Y(t);t.startsWith("before")?N(e._inc[s].before,i[t]):t.startsWith("after")&&N(e._inc[s].after,i[t])})},extendObject:function(t,i){let e=t.prototype;e&&Object.getOwnPropertyNames(i).forEach(t=>{e[t]||(e[t]=i[t])})},initPointer:function(){let t=n();t.addEventListener("mousedown",Q),t.addEventListener("touchstart",Q),t.addEventListener("mouseup",V),t.addEventListener("touchend",V),t.addEventListener("touchcancel",V),t.addEventListener("blur",tt),t.addEventListener("mousemove",Z),t.addEventListener("touchmove",Z),s("tick",()=>{K.length=0,U.map(t=>{K.push(t)}),U.length=0})},pointer:G,track:function(...t){t.map(t=>{t._r||(t._r=t.render,t.render=function(){U.push(this),this._r()},B.push(t))})},untrack:function(...t){t.map(t=>{t.render=t._r,t._r=0;let i=B.indexOf(t);-1!==i&&B.splice(i,1)})},pointerOver:function(t){return!!B.includes(t)&&J()===t},onPointerDown:function(t){q.onDown=t},onPointerUp:function(t){q.onUp=t},pointerPressed:function(t){return!!F[t]},Pool:et,Quadtree:nt,Sprite:ot,SpriteSheet:at,setStoreItem:function(t,i){void 0===i?localStorage.removeItem(t):localStorage.setItem(t,JSON.stringify(i))},getStoreItem:function(t){let i=localStorage.getItem(t);try{i=JSON.parse(i)}catch(t){}return i},Text:ct,TileEngine:function(t={}){let{width:i,height:e,tilewidth:s,tileheight:h,context:r=o(),tilesets:a,layers:c}=t,l=i*s,d=e*h,u=document.createElement("canvas"),f=u.getContext("2d");u.width=l,u.height=d;let g={},_={},p=[],m=Object.assign({context:r,mapwidth:l,mapheight:d,_sx:0,_sy:0,_d:!1,get sx(){return this._sx},get sy(){return this._sy},set sx(t){this._sx=Math.min(Math.max(0,t),l-n().width),p.forEach(t=>t.sx=this._sx)},set sy(t){this._sy=Math.min(Math.max(0,t),d-n().height),p.forEach(t=>t.sy=this._sy)},render(){this._d&&(this._d=!1,this._p()),v(u)},renderLayer(t){let i=_[t],e=g[t];i||((i=document.createElement("canvas")).width=l,i.height=d,_[t]=i,m._r(e,i.getContext("2d"))),e._d&&(e._d=!1,i.getContext("2d").clearRect(0,0,i.width,i.height),m._r(e,i.getContext("2d"))),v(i)},layerCollidesWith(t,i){let e=i.x,s=i.y;i.anchor&&(e-=i.width*i.anchor.x,s-=i.height*i.anchor.y);let h=x(s),n=w(e),o=x(s+i.height),r=w(e+i.width),a=g[t];for(let t=h;t<=o;t++)for(let i=n;i<=r;i++)if(a.data[i+t*this.width])return!0;return!1},tileAtLayer(t,i){let e=i.row||x(i.y),s=i.col||w(i.x);return g[t]?g[t].data[s+e*m.width]:-1},setTileAtLayer(t,i,e){let s=i.row||x(i.y),h=i.col||w(i.x);g[t]&&(g[t]._d=!0,g[t].data[h+s*m.width]=e)},setLayer(t,i){g[t]&&(g[t]._d=!0,g[t].data=i)},addObject(t){p.push(t),t.sx=this._sx,t.sy=this._sy},removeObject(t){let i=p.indexOf(t);-1!==i&&(p.splice(i,1),t.sx=t.sy=0)},_r:function(t,i){i.save(),i.globalAlpha=t.opacity,t.data.map((t,e)=>{if(!t)return;let s;for(let i=m.tilesets.length-1;i>=0&&(s=m.tilesets[i],!(t/s.firstgid>=1));i--);let h=s.tilewidth||m.tilewidth,n=s.tileheight||m.tileheight,o=s.margin||0,r=s.image,a=t-s.firstgid,c=s.columns||r.width/(h+o)|0,l=e%m.width*h,d=(e/m.width|0)*n,u=a%c*(h+o),f=(a/c|0)*(n+o);i.drawImage(r,u,f,h,n,l,d,h,n)}),i.restore()},_p:y},t);function x(t){return t/m.tileheight|0}function w(t){return t/m.tilewidth|0}function y(){m.layers&&m.layers.map(t=>{t._d=!1,g[t.name]=t,!1!==t.visible&&m._r(t,f)})}function v(t){const{width:i,height:e}=n(),s=Math.min(t.width,i),h=Math.min(t.height,e);m.context.drawImage(t,m.sx,m.sy,s,h,0,0,s,h)}return m.tilesets.map(i=>{let e=(window.__k?window.__k.dm.get(t):"")||window.location.href;if(i.source){let t=window.__k.d[window.__k.u(i.source,e)];Object.keys(t).map(e=>{i[e]=t[e]})}if(""+i.image===i.image){let t=window.__k.i[window.__k.u(i.image,e)];i.image=t}}),y(),m},Vector:M}}();